<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compare Victorian High Schools</title>

  <!-- SEO Essentials -->
  <meta name="description" content="Explore Victorian school performance: enrolments, VCE results, VET participation, staff ratios, and study score trends. Filter by school, suburb, postcode and more."/>
  <meta name="keywords" content="Compare schools, compare schools near me, compare victorian schools, Victorian schools, VCE results, VET participation, school performance, study scores, enrolments, staff ratios, education analytics, school profiles, Melbourne schools"/>
  <link rel="canonical" href="https://www.schoolcomparison.com.au/"/>

  <!-- Open Graph -->
  <meta property="og:title" content="Victorian School Performance Dashboard"/>
  <meta property="og:description" content="Filter and compare schools across enrolments, VCE results, VET, staff composition and more."/>
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://www.schoolcomparison.com.au/"/>
  <meta property="og:image" content="hero.png"/>

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="Victorian School Performance Dashboard"/>
  <meta name="twitter:description" content="Filter and compare schools across enrolments, VCE results, VET, staff composition and more."/>
  <meta name="twitter:image" content="hero.png"/>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Victorian School Performance Dashboard",
    "url": "https://www.schoolcomparison.com.au/",
    "description": "Interactive analytics for school performance across enrolments, VCE, VET and staffing.",
    "inLanguage": "en-AU",
    "publisher": {
      "@type": "Organization",
      "name": "Superlabs AU"
    }
  }
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /*========= THEME (edit these variables to reskin the site) =========*/
    :root{
      --font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      --font-base: 14px;
      --font-h1: 320px;
      --font-h2: 22px;
      --font-h3: 16px;

      --color-bg: #ffffff;
      --color-card: #ffffff;
      --color-text: #0f172a;
      --color-subtle: #475569;

      --color-brand: #0ea5e9;          /* header accents */
      --color-brand-dark: #0284c7;

      --color-table-header-bg: #0f172a; /* table header */
      --color-table-header-text: #e2e8f0;
      --color-table-row-border: #e5e7eb;

      --radius-card: 12px;
      --shadow-card: 0 4px 16px rgba(0,0,0,.06);
    }

    html,body{font-family:var(--font-family); font-size:var(--font-base); color:var(--color-text); background:var(--color-bg);}

    /* Header */
    .site-header{position:sticky;top:0;z-index:40;background:var(--color-card);border-bottom:1px solid #e2e8f0}
    .nav-link{position:relative;padding:.5rem .75rem;border-radius:.5rem;transition:transform .15s ease, background-color .2s ease}
    .nav-link:hover{background:rgba(14,165,233,.08);transform:translateY(-1px)}
    .nav-link:active{transform:translateY(0)}
    .brand-dot{width:8px;height:8px;border-radius:999px;background:var(--color-brand);display:inline-block;margin-right:.4rem}

    /* Hero */
    .hero{border-radius:var(--radius-card);box-shadow:var(--shadow-card);overflow:hidden}
    .hero-img{width:100%;height:auto;object-fit:contain}
    @media(min-width:768px){.hero-img{height:300px}}

    /* Card & table */
    .card{background:var(--color-card);border:1px solid #e5e7eb;border-radius:var(--radius-card);box-shadow:var(--shadow-card)}
    .table-wrapper{border:1px solid var(--color-table-row-border);border-radius:var(--radius-card);overflow:hidden}
    .table-scroller{max-height:520px;overflow:auto}
    th,td{white-space:nowrap}
    thead th{background:var(--color-table-header-bg);color:var(--color-table-header-text)}

    /* Pills */
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px;color:var(--color-subtle);background:#fff}

    /* Charts grid */
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}
    @media(min-width:640px){.charts-grid{gap:14px}}
    @media(min-width:1024px){.charts-grid{gap:16px}}
    .chart-card{background:var(--color-card);border:1px solid #e5e7eb;border-radius:var(--radius-card);padding:12px;box-shadow:var(--shadow-card)}
    .chart-h{height:240px}
    @media(min-width:640px){.chart-h{height:260px}}
    @media(min-width:1024px){.chart-h{height:280px}}
    @media(min-width:1280px){.chart-h{height:300px}}

    .legend-dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(0,0,0,.2)}

    /* Unified dropdown filters (search + multi-select) */
    .filter-group{position:relative}
    .filter-trigger{display:flex;align-items:center;justify-content:space-between;gap:.5rem;width:100%;padding:.5rem .6rem;border:1px solid #d1d5db;border-radius:.5rem;background:#fff;transition:border-color .15s ease, box-shadow .15s ease}
    .filter-trigger:hover{box-shadow:0 2px 10px rgba(2,132,199,.12);border-color:rgba(2,132,199,.35)}
    .filter-pop{position:absolute;left:0;top:100%;z-index:40;min-width:100%;max-height:320px;overflow:auto;margin-top:.25rem;background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;box-shadow:0 10px 20px rgba(0,0,0,.08)}
    .filter-search{width:100%;padding:.45rem .6rem;border-bottom:1px solid #eee;outline:none}
    .filter-option{display:flex;align-items:center;gap:.5rem;padding:.35rem .6rem}
    .filter-footer{display:flex;justify-content:flex-end;padding:.4rem .6rem;border-top:1px solid #eee}
    .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem}
    @media(min-width:640px){.filters-grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem}}
    @media(min-width:1024px){.filters-grid{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:.75rem}}

    .loading-spinner{border:3px solid #f3f3f3;border-top:3px solid var(--color-brand);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* Typography sizes via theme */
    h1{font-size:var(--font-h1)}
    h2{font-size:var(--font-h2)}
    h3{font-size:var(--font-h3)}
  </style>
</head>
<body>

  <!-- Header with logo + nav -->
  <header class="site-header">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-6">
      <a href="#" class="flex items-center gap-2 font-bold text-slate-900">
        <span class="brand-dot"></span>
        <span>School Comparison</span>
      </a>
      <nav class="ml-auto flex items-center gap-1">
        <a href="#" class="nav-link text-slate-700 hover:text-slate-900">Overview</a>
        <a href="#" class="nav-link text-slate-700 hover:text-slate-900">Compare</a>
        <a href="#" class="nav-link text-slate-700 hover:text-slate-900">Methodology</a>
      </nav>
    </div>
  </header>


  <img class="hero-img" alt="Victorian schools" src="hero.png"/>
  <div class="p-5 md:p-6">
    <h1 class="font-bold mb-1">Find your perfect school match </h1>
    <p class="text-slate-600">With so many choices, picking a school for your child can be hard to navigate. We bring together data and create insights to make the journey easier for you.</p>
  </div>
 

  <!-- Filters -->
  <section class="max-w-7xl mx-auto px-4 mt-6">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Filters</h2>
        <span id="selMeta" class="pill">Selected: 0</span>
      </div>
      <div id="unifiedFilters" class="filters-grid"></div>
    </div>
  </section>

  <!-- Selected schools -->
  <section class="max-w-7xl mx-auto px-4 mt-4">
    <div id="selectedSchoolsBar" class="card p-4" style="display:none">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Selected schools</h3>
      </div>
      <div id="legendItems" class="flex flex-wrap gap-2 text-sm mt-2"></div>
    </div>
  </section>

  <!-- Table -->
  <section class="max-w-7xl mx-auto px-4 mt-4">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-bold">All Schools</h2>
        <span id="tableMeta" class="text-sm text-slate-500"></span>
      </div>
      <div class="table-wrapper">
        <div class="table-scroller overflow-x-auto">
          <table class="min-w-full" id="schoolsTable"></table>
        </div>
      </div>
      <div class="flex items-center gap-2 justify-end mt-3">
        <button id="prevPage" class="px-3 py-2 border rounded-md">Prev</button>
        <span id="pageInfo" class="text-sm text-gray-600"></span>
        <button id="nextPage" class="px-3 py-2 border rounded-md">Next</button>
      </div>
    </div>
  </section>

  <!-- Chart Sections -->
  <section class="max-w-7xl mx-auto px-4 mt-8">
    <h2 class="font-bold mb-1">School profile</h2>
    <p class="text-slate-600 mb-3">Staff composition and language background indicators. Use the filters above and select schools to add them to charts.</p>
    <div id="chartsProfile" class="charts-grid">
      <!-- STAFF -->
      <div class="chart-card">
        <div class="flex items-center gap-2 mb-1">
          <!-- Icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-3-3.87M8 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
          <h3 class="font-semibold">Teaching vs Non-teaching staff (by year)</h3>
        </div>
        <p class="text-[10px] mb-1 text-slate-600">Indicator of staffing distribution.</p>
        <div class="chart-h"><canvas id="chartSTAFF"></canvas></div>
      </div>
      <!-- GENDER -->
      <div class="chart-card">
        <div class="flex items-center gap-2 mb-1">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="3"/><circle cx="15" cy="12" r="3"/><path d="M8 15v6M16 15v6"/></svg>
          <h3 class="font-semibold">Total enrolments: Girls vs Boys (by year)</h3>
        </div>
        <p class="text-[10px] mb-1 text-slate-600">Gender distribution across selected years.</p>
        <div class="chart-h"><canvas id="chartGENDER"></canvas></div>
      </div>
      <!-- LOTE -->
      <div class="chart-card">
        <div class="flex items-center gap-2 mb-1">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 5h16M4 12h16M4 19h16"/></svg>
          <h3 class="font-semibold">% speaking a language other than English</h3>
        </div>
        <p class="text-[10px] mb-1 text-slate-600">Cultural diversity proxy. Values are percentages.</p>
        <div class="chart-h"><canvas id="chartLOTE"></canvas></div>
      </div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 mt-10">
    <h2 class="font-bold mb-1">Enrolments</h2>
    <p class="text-slate-600 mb-3">Senior secondary participation indicators (Units 3 &amp; 4, VET certificates).</p>
    <div id="chartsEnrol" class="charts-grid">
      <div class="chart-card">
        <div class="flex items-center gap-2 mb-1">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-4 3 3 4-5"/></svg>
          <h3 class="font-semibold"># enrolled in any VCE/VM/VET (Units 3&4)</h3>
        </div>
        <div class="chart-h"><canvas id="chartA1"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="flex items-center gap-2 mb-1">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-4 3 3 4-5"/></svg>
          <h3 class="font-semibold"># enrolled in VET certificate</h3>
        </div>
        <div class="chart-h"><canvas id="chartA2"></canvas></div>
      </div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 mt-10 mb-12">
    <h2 class="font-bold mb-1">Performance</h2>
    <p class="text-slate-600 mb-3">Outcomes across VTAC applications, VCE completions, VET competencies and study scores.</p>
    <div id="chartsPerf" class="charts-grid">
      <div class="chart-card"><div class="flex items-center gap-2 mb-1"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/></svg><h3 class="font-semibold">% VCE students applying via VTAC</h3></div><div class="chart-h"><canvas id="chartB"></canvas></div></div>
      <div class="chart-card"><div class="flex items-center gap-2 mb-1"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/></svg><h3 class="font-semibold">% satisfactory VCE completions</h3></div><div class="chart-h"><canvas id="chartC"></canvas></div></div>
      <div class="chart-card"><div class="flex items-center gap-2 mb-1"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/></svg><h3 class="font-semibold"># awarded VCE (Baccalaureate)</h3></div><div class="chart-h"><canvas id="chartD"></canvas></div></div>
      <div class="chart-card"><div class="flex items-center gap-2 mb-1"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/></svg><h3 class="font-semibold">% VET units of competency completed</h3></div><div class="chart-h"><canvas id="chartE"></canvas></div></div>
      <div class="chart-card"><div class="flex items-center gap-2 mb-1"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/></svg><h3 class="font-semibold">Median VCE study score</h3></div><div class="chart-h"><canvas id="chartF"></canvas></div></div>
      <div class="chart-card"><div class="flex items-center gap-2 mb-1"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/></svg><h3 class="font-semibold">% study scores of 40 and over</h3></div><div class="chart-h"><canvas id="chartG"></canvas></div></div>
    </div>
  </section>

  <!-- Loading / Empty -->
  <section id="loading" class="max-w-7xl mx-auto px-4 mb-10">
    <div class="card p-12 text-center hidden">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-slate-600">Loading school data...</p>
    </div>
  </section>
  <section id="emptyState" class="max-w-7xl mx-auto px-4 mb-10">
    <div class="card p-12 text-center">
      <p class="text-slate-500">Data is loading…</p>
    </div>
  </section>

  <!-- Footer -->
  <footer class="mt-12 border-t">
    <div class="max-w-7xl mx-auto px-4 py-6 text-sm text-slate-600 flex flex-col md:flex-row gap-2 md:gap-6">
      <span>© <span id="yearNow"></span> School Insights</span>
      <a href="#" class="hover:text-slate-900">Privacy</a>
      <a href="#" class="hover:text-slate-900">Terms</a>
      <a href="#" class="hover:text-slate-900">Contact</a>
    </div>
  </footer>

  <script>
  // ===== State & constants =====
  const SERVER_DEFAULT = "https://my-sheets-api.onrender.com"; // Hardcoded server
  let YEARS = ["2021","2022","2023","2024"];
  let joinedRows = [];
  let filteredRows = [];
  let allRowsById = new Map();
  let selectedSchoolIds = new Set();
  let charts = {};
  let idColorMap = new Map();
  let currentPage = 1; const PAGE_SIZE = 25;

  let PROFILE_KEYS_FOR_FILTER = [];
  let PROFILE_HEADERS = [];
  let PROFILE_ROWS = [];
  let PROFILE_OBJS = [];
  let LOTE_YES_KEY = null;
  let NAME_KEY = 'School Name';
  let SUBURB_KEY = '';
  let POSTCODE_KEY = '';
  let URL_KEY = '';
  let YEAR_KEY = 'Calendar Year';

  const METRICS = {
    A1: { field: 'Number of students enrolled in at least one VCE, VM, VET program at Units 3 and 4 level' },
    A2: { field: 'Number of students enrolled in VET certificate' },
    B:  { field: 'Percentage of VCE students applying for tertiary places through VTAC' },
    C:  { field: 'Percentage of satisfactory VCE completions' },
    D:  { field: 'Number of students awarded the VCE (Baccalaureate)' },
    E:  { field: 'Percentage of VET units of competency completed' },
    F:  { field: 'Median VCE study score' },
    G:  { field: 'Percentage of study scores of 40 and over' }
  };

  // ===== TABLE CUSTOMISATION =====
  // You can fully customise the table from code by editing TABLE_CONFIG below.
  // Each column supports: key (data key), label (header text), width (px or CSS width),
  // visible (true/false), and order (number; lower shows first).
  // Leave as null to auto-generate; or define your own array of columns.
  // Example override:
  // window.TABLE_CONFIG = { columns: [
  //   { key: '__select', label: 'Compare', width: 60, visible: true, order: 0 },
  //   { key: 'School Name', label: 'School', width: 260, visible: true, order: 2 },
  //   { key: 'Suburb', label: 'Suburb', width: 160, visible: true, order: 3 },
  //   { key: 'Postcode', label: 'Postcode', width: 100, visible: true, order: 1 },
  //   { key: 'School URL', label: 'Website', width: 80, visible: true, order: 4 },
  //   // ... any other profile fields ...
  // ]};
   window.TABLE_CONFIG = { columns: [
         { key: '__select', label: 'Compare', width: 40, visible: true, order: 0 },
         { key: 'School Name', label: 'School', width: 260, visible: true, order: 3 },
         { key: 'Suburb', label: 'Suburb', width: 160, visible: true, order: 4 },
         { key: 'Postcode', label: 'Postcode', width: 80, visible: true, order: 5 },
         { key: 'School URL', label: 'Website', width: 40, visible: true, order: 2 },
         { key: 'School Sector', label: 'Website', width: 60, visible: true, order: 6 },
         { key: 'School Type', label: 'Website', width: 60, visible: true, order: 7 },
         { key: 'Year Range', label: 'Website', width: 40, visible: true, order: 8 },
  ]};

  function ensureTableConfig(){
    const sample = filteredRows[0] || joinedRows[0] || {};
    // Refresh key guesses from sample
    NAME_KEY = guessNameKey(sample);
    YEAR_KEY = Object.keys(sample).find(k=>/^(calendar\s*)?year$/i.test(k)) || YEAR_KEY;
    const keys = Object.keys(sample);
    SUBURB_KEY = keys.find(k=>/suburb/i.test(k)) || '';
    POSTCODE_KEY = keys.find(k=>/post\s*code|postcode/i.test(k)) || '';
    URL_KEY = keys.find(k=>/^(school\s*url|website|url)$/i.test(k)) || '';

    if(!window.TABLE_CONFIG || !Array.isArray(window.TABLE_CONFIG.columns)){
      // Build a sensible default config from discovered keys
      const cols = [];
      cols.push({ key:'__select', label:'Add to graph', width:120, visible:true, order:0 });
      cols.push({ key:NAME_KEY, label:NAME_KEY, width:240, visible:true, order:1 });
      if(SUBURB_KEY) cols.push({ key:SUBURB_KEY, label:SUBURB_KEY, width:160, visible:true, order:2 });
      if(POSTCODE_KEY) cols.push({ key:POSTCODE_KEY, label:POSTCODE_KEY, width:120, visible:true, order:3 });
      if(URL_KEY) cols.push({ key:URL_KEY, label:'Website', width:80, visible:true, order:4 });

      let order=10;
      PROFILE_KEYS_FOR_FILTER.forEach(k=>{
        if([NAME_KEY,SUBURB_KEY,POSTCODE_KEY,URL_KEY].includes(k)) return;
        const visible = !/school\s*id/i.test(k); // hide School ID by default
        cols.push({ key:k, label:k, width:180, visible, order:order++ });
      });

      window.TABLE_CONFIG = { columns: cols };
    } else {
      // If user provided a config, keep it but ensure special column exists
      const hasSelect = window.TABLE_CONFIG.columns.some(c=>c.key==='__select');
      if(!hasSelect){ window.TABLE_CONFIG.columns.unshift({ key:'__select', label:'Add to graph', width:120, visible:true, order:0 }); }
    }
  }

  function getActiveColumns(){
    const cols = (window.TABLE_CONFIG?.columns || []).slice();
    cols.sort((a,b)=> (a.order??999) - (b.order??999));
    return cols.filter(c => c.visible !== false);
  }

  // ===== Utilities =====
  const $ = (id)=>document.getElementById(id);
  function uniq(a){ return [...new Set(a)] }
  function norm(s){ return String(s||"").replace(/\s+/g," ").trim().toLowerCase(); }
  function parseFlatHeader(h){ const p=String(h).split('|').map(s=>s.trim()); return {category:p[0]||'', field:p[1]||'', year:p[2]||''}; }
  function guessIdKey(r){ const k=Object.keys(r||{}); return k.find(x=>x.toLowerCase().includes('school')&&x.toLowerCase().includes('id'))||'School ID'; }
  function guessNameKey(r){ const k=Object.keys(r||{}); return k.find(x=>/name/i.test(x))||'School Name'; }
  function a1ToIndex(col){ let n=0; for(const ch of col) n=n*26+(ch.charCodeAt(0)-64); return n-1 }
  function formatUrl(u){ const s=String(u||'').trim(); if(!s) return ''; if(/^https?:\/\//i.test(s)) return s; return 'https://'+s; }
  function yearMatch(hYear, y){ const s=String(hYear||''); return s.includes(y); }

  function computePaletteForSelected(){
    const rows = rowsForSelected();
    const idKey = rows.length ? guessIdKey(rows[0]) : (joinedRows.length?guessIdKey(joinedRows[0]):'School ID');
    const ids = rows.map(r=>String(r[idKey])); const n=Math.max(1,ids.length); const map=new Map();
    ids.forEach((id,i)=>{ const hue=Math.round((360*i)/n); map.set(id,`hsl(${hue} 70% 50%)`); });
    idColorMap = map;
  }
  function colorForId(id){ return idColorMap.get(String(id)) || 'hsl(0 0% 50%)'; }
  function colorWithAlpha(c,a){ const m=c.match(/hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/i); if(m){return `hsla(${m[1]} ${m[2]}% ${m[3]}% / ${a})`} return c;}
  function schoolNameForRow(r){ return r[NAME_KEY] || r[guessNameKey(r)] || 'School'; }

  // Selected schools pill bar
  function updateGlobalLegend(){
    const wrap = $('legendItems'); if(!wrap) return; wrap.innerHTML='';
    const rows = rowsForSelected(); const idKey = joinedRows.length ? guessIdKey(joinedRows[0]) : 'School ID';
    rows.forEach(r=>{
      const id = String(r[idKey]); const color = colorForId(id);
      const badge = document.createElement('span');
      badge.className = 'pill';
      const dot = document.createElement('span'); dot.className='legend-dot'; dot.style.background = color;
      const label = document.createElement('span'); label.textContent = schoolNameForRow(r);
      const close = document.createElement('button');
      close.type = 'button'; close.className = 'ml-1 text-gray-500 hover:text-gray-700'; close.setAttribute('aria-label','Remove');
      close.innerHTML = '&times;';
      close.addEventListener('click', ()=>{
        selectedSchoolIds.delete(id);
        document.querySelectorAll(`#schoolsTable tbody input[type="checkbox"][data-sid="${CSS.escape(id)}"]`).forEach(cb=> cb.checked = false);
        refreshAllCharts();
        updateSelectedMeta();
        updateGlobalLegend();
      });
      badge.appendChild(dot); badge.appendChild(label); badge.appendChild(close);
      wrap.appendChild(badge);
    });
    const bar = document.getElementById('selectedSchoolsBar'); if(bar){ bar.style.display = rows.length ? '' : 'none'; }
  }

  // ===== Filtering (unified dropdowns) =====
  const activeMulti = {};            // key -> Set(values)
  const OPEN_POPOVERS = new Set();   // track open popovers

  function valuesForKey(key){
    return uniq(joinedRows.map(r=>r[key]).filter(v=>v!==undefined && v!=='')).sort((a,b)=>String(a).localeCompare(String(b)));
  }

  // Robustly extract joined rows from /api/schools payload
  function extractJoinedRows(obj){
    if(!obj) return [];
    if(Array.isArray(obj)) return obj;
    if(Array.isArray(obj.data)) return obj.data;
    if(obj.data && Array.isArray(obj.data.rows)) return obj.data.rows;
    if(Array.isArray(obj.rows)) return obj.rows;
    if(obj.result && Array.isArray(obj.result)) return obj.result;
    if(obj.result && Array.isArray(obj.result.data)) return obj.result.data;
    return [];
  }

  function renderFilterDropdown(host, key, label){
    const group = document.createElement('div');
    group.className = 'filter-group';
    group.dataset.key = key;

    const trigger = document.createElement('button');
    trigger.type = 'button';
    trigger.className = 'filter-trigger';
    trigger.innerHTML = `<span>${label}</span><span class="text-xs text-slate-500 sel-summary">Any</span>`;

    const pop = document.createElement('div');
    pop.className = 'filter-pop hidden';

    const search = document.createElement('input');
    search.type = 'text';
    search.className = 'filter-search';
    search.placeholder = `Search ${label}...`;

    const list = document.createElement('div');

    const opts = valuesForKey(key);
    function syncList(filterText=''){
      list.innerHTML = '';
      const ft = filterText.toLowerCase();
      const sel = activeMulti[key] || new Set();
      opts
        .filter(v => !ft || String(v).toLowerCase().includes(ft))
        .forEach(v=>{
          const row = document.createElement('label');
          row.className = 'filter-option';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = sel.has(String(v));
          cb.addEventListener('change', ()=>{
            if(!activeMulti[key]) activeMulti[key] = new Set();
            if(cb.checked) activeMulti[key].add(String(v));
            else activeMulti[key].delete(String(v));
            updateSelSummary();
            applyFilters();
          });
          const span = document.createElement('span');
          span.textContent = v;
          row.appendChild(cb); row.appendChild(span);
          list.appendChild(row);
        });
    }

    function updateSelSummary(){
      const sel = activeMulti[key] || new Set();
      const summary = trigger.querySelector('.sel-summary');
      if(summary){ summary.textContent = sel.size ? `${sel.size} selected` : 'Any'; }
    }

    search.addEventListener('input', ()=> syncList(search.value));

    const footer = document.createElement('div');
    footer.className = 'filter-footer';
    const btnClose = document.createElement('button');
    btnClose.type = 'button'; btnClose.className = 'px-2 py-1 border rounded-md'; btnClose.textContent = 'Close';
    btnClose.addEventListener('click', ()=> { pop.classList.add('hidden'); OPEN_POPOVERS.delete(pop); });
    footer.appendChild(btnClose);

    pop.appendChild(search);
    pop.appendChild(list);
    pop.appendChild(footer);

    trigger.addEventListener('click', (e)=>{
      e.stopPropagation();
      const isHidden = pop.classList.contains('hidden');
      document.querySelectorAll('.filter-pop').forEach(p=>{ if(p!==pop){ p.classList.add('hidden'); OPEN_POPOVERS.delete(p); } });
      if(isHidden){ pop.classList.remove('hidden'); OPEN_POPOVERS.add(pop); search.focus(); }
      else { pop.classList.add('hidden'); OPEN_POPOVERS.delete(pop); }
    });

    // initial render
    syncList();
    updateSelSummary();

    group.appendChild(trigger);
    group.appendChild(pop);
    host.appendChild(group);
  }

  function buildProfileFilterKeys(profileHeaders){
    const exclude=/campus\s*type|rolled\s*reporting|school\s*id|geo\s*location/i;
    const wanted=[
      ...Array.from({length:a1ToIndex('L')-a1ToIndex('E')+1},(_,i)=>profileHeaders[a1ToIndex('E')+i]),
      ...Array.from({length:a1ToIndex('Q')-a1ToIndex('P')+1},(_,i)=>profileHeaders[a1ToIndex('P')+i])
    ].filter(Boolean).filter(h=>!exclude.test(String(h)));
    return wanted;
  }

  function buildSidebarFilters(){
    const host = document.getElementById('unifiedFilters');
    host.innerHTML = '';

    const sample = joinedRows[0] || {};
    NAME_KEY = guessNameKey(sample);
    YEAR_KEY = Object.keys(sample).find(k=>/^(calendar\s*)?year$/i.test(k)) || YEAR_KEY;
    const keys = Object.keys(sample);
    SUBURB_KEY = keys.find(k=>/suburb/i.test(k)) || '';
    POSTCODE_KEY = keys.find(k=>/post\s*code|postcode/i.test(k)) || '';
    URL_KEY = keys.find(k=>/^(school\s*url|website|url)$/i.test(k)) || '';

    const fieldKeys = PROFILE_KEYS_FOR_FILTER.filter(k => k && k !== URL_KEY);

    if(NAME_KEY) renderFilterDropdown(host, NAME_KEY, 'School');
    if(SUBURB_KEY) renderFilterDropdown(host, SUBURB_KEY, 'Suburb');
    if(POSTCODE_KEY) renderFilterDropdown(host, POSTCODE_KEY, 'Postcode');

    fieldKeys.forEach(k=>{ if(k===NAME_KEY || k===SUBURB_KEY || k===POSTCODE_KEY) return; renderFilterDropdown(host, k, k); });

    document.addEventListener('click', (evt)=>{
      document.querySelectorAll('.filter-pop').forEach(p=>{
        if(!p.contains(evt.target) && !p.previousSibling.contains(evt.target)){
          p.classList.add('hidden'); OPEN_POPOVERS.delete(p);
        }
      });
    });
  }

  // ===== Table =====
  function renderTableHeader(){
    const tbl=$('schoolsTable'); tbl.innerHTML=''; if(!filteredRows.length && !joinedRows.length) return;
    ensureTableConfig();

    const thead=document.createElement('thead');
    const tr=document.createElement('tr');
    const mk=(col)=>{ const th=document.createElement('th'); th.className='px-3 py-2 text-left'; th.style.background='var(--color-table-header-bg)'; th.style.color='var(--color-table-header-text)'; if(col.width){ th.style.width = (typeof col.width==='number'? col.width+'px' : col.width); } th.textContent=col.label ?? col.key; return th; }

    getActiveColumns().forEach(col=>{ tr.appendChild(mk(col)); });

    thead.appendChild(tr); $('schoolsTable').appendChild(thead);

    renderTableBody();
  }

  function renderTableBody(){
    const tbl=$('schoolsTable'); const old=tbl.querySelector('tbody'); if(old) old.remove();
    const tb=document.createElement('tbody');

    if(!filteredRows.length){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=getActiveColumns().length||1; td.className='px-3 py-3 text-slate-500'; td.textContent='No rows'; tr.appendChild(td); tb.appendChild(tr); tbl.appendChild(tb); updatePager(); return; }

    const idKey = guessIdKey(filteredRows[0]);
    const start=(currentPage-1)*PAGE_SIZE; const end=Math.min(start+PAGE_SIZE, filteredRows.length);
    const cols = getActiveColumns();

    for(let i=start;i<end;i++){
      const r=filteredRows[i]; const idVal=r[idKey];
      const tr=document.createElement('tr');

      cols.forEach(col=>{
        const td=document.createElement('td'); td.className='px-3 py-2 border-b'; td.style.borderColor='var(--color-table-row-border)'; if(col.width){ td.style.width=(typeof col.width==='number'? col.width+'px' : col.width); }

        if(col.key==='__select'){
          const cb=document.createElement('input'); cb.type='checkbox'; cb.className='accent-blue-600'; cb.dataset.sid=String(idVal); cb.checked=selectedSchoolIds.has(String(idVal));
          cb.addEventListener('change',()=>{ const sid=String(idVal); if(cb.checked) selectedSchoolIds.add(sid); else selectedSchoolIds.delete(sid); refreshAllCharts(); updateSelectedMeta(); updateGlobalLegend(); });
          td.appendChild(cb);
        } else if (URL_KEY && col.key===URL_KEY) {
          const val=r[col.key]; if(val){ const a=document.createElement('a'); a.href=formatUrl(val); a.target='_blank'; a.rel='noopener'; a.setAttribute('title','Open website'); a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>'; td.appendChild(a);} }
        else {
          td.textContent = r[col.key] ?? '';
        }

        tr.appendChild(td);
      });

      tb.appendChild(tr);
    }

    tbl.appendChild(tb); updatePager();
  }

  function updatePager(){
    document.getElementById('tableMeta').textContent = `${filteredRows.length.toLocaleString()} matched rows`;
    const pages=Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE));
    document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${pages}`;
    document.getElementById('prevPage').disabled = currentPage<=1; document.getElementById('nextPage').disabled = currentPage>=pages;
  }

  // ===== Data keys panel =====
  function renderKeysInto(elId, arr){
    const el = document.getElementById(elId);
    if(!el) return;
    if(!arr || !arr.length){ el.textContent = '(none)'; return; }
    // show as line-separated for easy copy
    el.textContent = arr.join('\n');
  }
  function updateDataKeysPanel(){
    // Joined keys from a sample row
    const sampleJoined = filteredRows[0] || joinedRows[0] || {};
    const joinedKeys = Object.keys(sampleJoined).sort((a,b)=>a.localeCompare(b));
    renderKeysInto('joinedKeysPre', joinedKeys);
    // Profile headers
    const profKeys = (PROFILE_HEADERS || []).slice().sort((a,b)=>String(a).localeCompare(String(b)));
    renderKeysInto('profileKeysPre', profKeys);
    // Wire copy buttons
    const btnJ = document.getElementById('copyJoinedKeys');
    const btnP = document.getElementById('copyProfileKeys');
    if(btnJ){ btnJ.onclick = ()=> navigator.clipboard?.writeText(joinedKeys.join('\n')); }
    if(btnP){ btnP.onclick = ()=> navigator.clipboard?.writeText(profKeys.join('\n')); }
  }

  function applyFilters(resetPage=true){
    filteredRows = joinedRows.filter(r=>{
      for(const [k,set] of Object.entries(activeMulti)){
        if(set && set.size){ const val = String(r[k] ?? ''); if(!set.has(val)) return false; }
      }
      return true;
    });
    if(resetPage) currentPage=1;
    renderTableBody(); refreshAllCharts(); updateSelectedMeta(); updateGlobalLegend();
    updateDataKeysPanel();
  }

  // ===== Performance charts =====
  function headersForField(field){
    const sample=joinedRows[0]||{}; const keys=Object.keys(sample); const out={}; const nf=norm(field);
    for(const y of YEARS){
      let key = keys.find(k=>k.includes('|') && norm(parseFlatHeader(k).field)===nf && yearMatch(parseFlatHeader(k).year,y));
      if(!key){ key = keys.find(k=>k.includes('|') && norm(parseFlatHeader(k).field).includes(nf) && yearMatch(parseFlatHeader(k).year,y)) || null; }
      out[y]=key;
    } return out;
  }
  function datasetPerSchoolLine(rows, field, headers){
    const nameKey=rows.length?guessNameKey(rows[0]):NAME_KEY; const idKey=joinedRows.length?guessIdKey(joinedRows[0]):'School ID';
    return rows.map((r,idx)=>{ const id=String(r[idKey]); const base=colorForId(id);
      return { label:r[nameKey]||`School ${idx+1}`, data:YEARS.map(y=>{ const k=headers[y]; const v=k?Number(r[k]):NaN; return isNaN(v)?0:v; }), borderColor:base, backgroundColor:colorWithAlpha(base,.25), pointBackgroundColor:base, pointBorderColor:base, fill:false, tension:.15 };
    });
  }
  function renderLineChart(key, field){
    const rows=rowsForSelected(); const ctx=document.getElementById(`chart${key}`).getContext('2d'); const cols=headersForField(field);
    if(charts[key]) charts[key].destroy();
    charts[key]=new Chart(ctx,{type:'line', data:{labels:YEARS, datasets:datasetPerSchoolLine(rows,field,cols)}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});
  }

  // ===== Profile charts (row-based) =====
  function parseYearVal(v){ const m=String(v??'').match(/\b(19|20)\d{2}\b/); return m?parseInt(m[0],10):NaN; }
  function guessProfileIdKey(){ const sample=PROFILE_OBJS[0]||joinedRows[0]||{}; const k=Object.keys(sample); return k.find(x=>x.toLowerCase().includes('school')&&x.toLowerCase().includes('id'))||'School ID'; }
  function lookupProfileRow(id, year){
    const idKey=guessProfileIdKey(); const target=parseInt(year,10); const rows=PROFILE_OBJS.filter(r=>String(r[idKey])===String(id));
    let exact = rows.find(r=>{ const ystr=String(r?.[YEAR_KEY]??''); return ystr.includes(String(year)) || parseYearVal(ystr)===target; });
    if(exact) return exact;
    const candidates=rows.map(r=>({r,y:parseYearVal(r?.[YEAR_KEY])})).filter(x=>!isNaN(x.y)&&x.y<=target).sort((a,b)=>b.y-a.y);
    return candidates[0]?.r||null;
  }
  function lookupProfileValue(id, year, candidates){
    const row=lookupProfileRow(id,year); if(!row) return 0; const wanted=(Array.isArray(candidates)?candidates:[candidates]).map(norm);
    const key=Object.keys(row).find(k=>wanted.some(w=>norm(k).includes(w))); const v=Number(key?row[key]:0); return isFinite(v)?v:0;
  }
  function lookupProfileValueFixedKey(id, year, fixedKey){
    const row=lookupProfileRow(id,year); const v=Number(row?.[fixedKey]??0); return isFinite(v)?v:0;
  }
  function asPercent100(v){ const n=Number(v); if(!isFinite(n)) return 0; if(n>=0 && n<=1) return n*100; return n; }

  function rowsForSelected(){ const idKey=joinedRows.length?guessIdKey(joinedRows[0]):'School ID'; const byId=(id)=>allRowsById.get(String(id)); return Array.from(selectedSchoolIds).map(id=>byId(id)).filter(Boolean); }
  function updateSelectedMeta(){ const el=document.getElementById('selMeta'); if(el) el.textContent=`Selected: ${selectedSchoolIds.size}`; }

  function profilePairDatasetsByYear(rows, pair){
    const idKey=guessIdKey(joinedRows[0]||{}); const labels=rows.map(r=>schoolNameForRow(r)); const datasets=[];
    for(const y of YEARS){
      const colors = rows.map(r=>colorForId(String(r[idKey])));
      const dataAraw = rows.map(r=>{ const id=String(r[idKey]); return pair.fixedAKey?lookupProfileValueFixedKey(id,y,pair.fixedAKey):lookupProfileValue(id,y,pair.aCandidates||[pair.aLabel]); });
      let   dataBraw = rows.map(r=>{ const id=String(r[idKey]); return pair.fixedBKey?lookupProfileValueFixedKey(id,y,pair.fixedBKey):lookupProfileValue(id,y,pair.bCandidates||[pair.bLabel]); });
      if(pair.percentFallback){
        const A=dataAraw.map(asPercent100); let B=dataBraw.map(asPercent100); if(!(pair.fixedBKey || (pair.bCandidates && pair.bCandidates.length))){ B=A.map(v=>Math.max(0,100-v)); }
        datasets.push({label:`${pair.aLabel} (${y})`,data:A,backgroundColor:colors.map(c=>colorWithAlpha(c,.65)),borderColor:colors,borderWidth:1,stack:`stack-${y}`});
        datasets.push({label:`${pair.bLabel} (${y})`,data:B,backgroundColor:colors.map(c=>colorWithAlpha(c,.35)),borderColor:colors,borderWidth:1,stack:`stack-${y}`});
      } else {
        const A=dataAraw.map(v=>isFinite(v)?v:0); const B=dataBraw.map(v=>isFinite(v)?v:0);
        datasets.push({label:`${pair.aLabel} (${y})`,data:A,backgroundColor:colors.map(c=>colorWithAlpha(c,.65)),borderColor:colors,borderWidth:1,stack:`stack-${y}`});
        datasets.push({label:`${pair.bLabel} (${y})`,data:B,backgroundColor:colors.map(c=>colorWithAlpha(c,.35)),borderColor:colors,borderWidth:1,stack:`stack-${y}`});
      }
    }
    return { labels, datasets };
  }

  function renderStackedProfilePairByYear(canvasId, pair){
    const rows=rowsForSelected(); const ctx=document.getElementById(canvasId).getContext('2d');
    if(charts[canvasId]) charts[canvasId].destroy();
    const {labels,datasets}=profilePairDatasetsByYear(rows,pair);
    charts[canvasId]=new Chart(ctx,{type:'bar', data:{labels,datasets}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, tooltip:{mode:'index',intersect:false}}, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true, suggestedMax: pair.percentFallback?100:undefined}}}});
  }

  function refreshAllCharts(){
    const selected = rowsForSelected();
    if(selected.length === 0){
      Object.keys(charts).forEach(k=>{ if(charts[k]){ try{ charts[k].destroy(); }catch(_){} } });
      updateGlobalLegend();
      return;
    }

    computePaletteForSelected();
    // Performance (lines)
    renderLineChart('A1', METRICS.A1.field);
    renderLineChart('A2', METRICS.A2.field);
    renderLineChart('B', METRICS.B.field);
    renderLineChart('C', METRICS.C.field);
    renderLineChart('D', METRICS.D.field);
    renderLineChart('E', METRICS.E.field);
    renderLineChart('F', METRICS.F.field);
    renderLineChart('G', METRICS.G.field);
    // Profile (stacked)
    renderStackedProfilePairByYear('chartSTAFF', { aLabel:'Teaching staff', aCandidates:['Teaching staff','Teachers','Number of teaching staff'], bLabel:'Non-teaching staff', bCandidates:['Non teaching staff','Non-teaching staff','Number of non teaching staff'] });
    renderStackedProfilePairByYear('chartGENDER', { aLabel:'Girls enrolments', aCandidates:['Total girls enrolment','Girls enrolment','Female enrolments'], bLabel:'Boys enrolments', bCandidates:['Total boys enrolment','Boys enrolment','Male enrolments'] });
    renderStackedProfilePairByYear('chartLOTE', { aLabel:'LOTE: Yes', bLabel:'LOTE: No', percentFallback:true, fixedAKey: LOTE_YES_KEY });

    updateGlobalLegend();
  }

  // ===== Years & load =====
  function parseYearFromAny(v){
    const m = String(v ?? '').match(/\b(19|20)\d{2}\b/);
    return m ? parseInt(m[0],10) : undefined;
  }
  function deriveYearsFromHeaders(){
    const src = PROFILE_OBJS.length ? PROFILE_OBJS : joinedRows;
    const years = src.map(r => parseYearFromAny(r?.[YEAR_KEY])).filter(Boolean);
    const uniqYears=[...new Set(years)].sort((a,b)=>a-b).map(String);
    return uniqYears.slice(-4);
  }

  async function loadAll(){
    document.querySelector('#loading .card')?.classList.remove('hidden');
    document.getElementById('emptyState').classList.add('hidden');

    try{
      const base = SERVER_DEFAULT.replace(/\/$/, '');
      const ts = Date.now();
      const profRes = await fetch(`${base}/api/profile?t=${ts}`, { cache: 'no-store' });
      const joinRes = await fetch(`${base}/api/schools?onlyMatched=true&t=${ts}`, { cache: 'no-store' });

      if(!profRes.ok){ throw new Error(`Profile API error ${profRes.status}`); }
      if(!joinRes.ok){ throw new Error(`Schools API error ${joinRes.status}`); }

      const [profText, joinText] = await Promise.all([profRes.text(), joinRes.text()]);
      const profJson = JSON.parse(profText);
      const joinedJson = JSON.parse(joinText);

      PROFILE_HEADERS = profJson.headers || [];
      const agIndex = a1ToIndex('AG');
      LOTE_YES_KEY = PROFILE_HEADERS[agIndex]
        || PROFILE_HEADERS.find(h=>/language\s+other\s+than\s+english|lote/i.test(String(h)))
        || null;

      PROFILE_ROWS = profJson.rows || profJson.data || [];
      if(Array.isArray(PROFILE_ROWS) && PROFILE_ROWS.length && Array.isArray(PROFILE_ROWS[0])){
        PROFILE_OBJS = PROFILE_ROWS.map(arr=>{ const o={}; PROFILE_HEADERS.forEach((h,i)=>{ o[h]=arr[i]; }); return o; });
      } else if (Array.isArray(PROFILE_ROWS)) {
        PROFILE_OBJS = PROFILE_ROWS;
      } else {
        PROFILE_OBJS = [];
      }

      joinedRows = (Array.isArray(joinedJson) ? joinedJson
                  : Array.isArray(joinedJson.data) ? joinedJson.data
                  : joinedJson?.data?.rows || joinedJson?.rows || []);
      if(!Array.isArray(joinedRows)) joinedRows = [];
      filteredRows = [...joinedRows];

      allRowsById = new Map(); if(joinedRows.length){ const idKey=guessIdKey(joinedRows[0]); joinedRows.forEach(r=>{ const id=String(r[idKey]); if(id) allRowsById.set(id,r); }); }

      const derived=deriveYearsFromHeaders(); if(derived.length) YEARS=derived;

      PROFILE_KEYS_FOR_FILTER = buildProfileFilterKeys(PROFILE_HEADERS);
      buildSidebarFilters();

      ensureTableConfig(); // <-- build table config once keys are known
      renderTableHeader();
      applyFilters(false); // initial render
      refreshAllCharts();
      updateSelectedMeta();
      updateDataKeysPanel();
    }catch(e){
      console.error(e);
      alert('Failed to load data. Please try again later.');
    }finally{
      document.querySelector('#loading .card')?.classList.add('hidden');
    }
  }

  // ===== Events =====
  window.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('yearNow').textContent = new Date().getFullYear();
    loadAll(); // auto-load on page load
    document.getElementById('prevPage').addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderTableBody(); }});
    document.getElementById('nextPage').addEventListener('click', ()=>{ const pages=Math.max(1, Math.ceil(filteredRows.length/PAGE_SIZE)); if(currentPage<pages){ currentPage++; renderTableBody(); }});
  });
  </script>
</body>
</html>
